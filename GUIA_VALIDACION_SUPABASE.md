# üîç Gu√≠a de Validaci√≥n de Datos en Supabase

## üìã Checklist de Validaci√≥n

Sigue estos pasos en orden para validar que el sistema de tracking est√© funcionando correctamente.

---

## üöÄ PASO 1: Acceder a Supabase

1. **Abrir navegador**
2. **Ir a**: https://supabase.com/dashboard
3. **Login** con tu cuenta
4. **Seleccionar** tu proyecto de Coworking

---

## üìä PASO 2: Verificar Tablas

### **M√©todo Visual (Table Editor)**

1. En el men√∫ izquierdo ‚Üí **Table Editor**
2. Deber√≠as ver estas tablas:
   - ‚úÖ `properties`
   - ‚úÖ `property_likes`
   - ‚úÖ `property_views`
   - ‚úÖ `property_contacts`
   - ‚úÖ `page_analytics`
   - ‚úÖ `advisor_interactions`

### **M√©todo SQL (Recomendado)**

1. En el men√∫ izquierdo ‚Üí **SQL Editor**
2. Click **+ New Query**
3. Pega este c√≥digo:

```sql
-- Verificar que todas las tablas existen
SELECT table_name
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN (
    'property_likes', 
    'property_views', 
    'property_contacts', 
    'page_analytics', 
    'advisor_interactions'
  )
ORDER BY table_name;
```

4. Click **Run** (o Ctrl+Enter)
5. **Resultado esperado**: 5 filas

**‚úÖ Si ves 5 tablas** ‚Üí Contin√∫a al siguiente paso  
**‚ùå Si ves menos de 5** ‚Üí Ejecuta `CREATE_ANALYTICS_TABLES.sql` primero

---

## üìà PASO 3: Contar Registros

### **Verificar si hay datos**

```sql
-- Contar registros en cada tabla
SELECT 'property_likes' as tabla, COUNT(*) as total FROM property_likes
UNION ALL
SELECT 'property_views' as tabla, COUNT(*) as total FROM property_views
UNION ALL
SELECT 'property_contacts' as tabla, COUNT(*) as total FROM property_contacts
ORDER BY tabla;
```

**Interpretaci√≥n**:
- **Total = 0** ‚Üí No hay datos todav√≠a (normal si acabas de crear las tablas)
- **Total > 0** ‚Üí ¬°Hay datos! El tracking est√° funcionando

---

## üëÅÔ∏è PASO 4: Ver √öltimas Vistas

```sql
-- Ver las √∫ltimas 10 vistas registradas
SELECT 
  id,
  property_id,
  session_id,
  view_duration as "segundos",
  device_type as "dispositivo",
  referrer,
  created_at as "fecha"
FROM property_views
ORDER BY created_at DESC
LIMIT 10;
```

**¬øQu√© verificar?**
- ‚úÖ `property_id`: debe ser un n√∫mero (ej: 123)
- ‚úÖ `session_id`: debe tener formato `session_123456789_abc`
- ‚úÖ `view_duration`: segundos que estuvo viendo (ej: 15, 30, 45)
- ‚úÖ `device_type`: desktop, mobile o tablet
- ‚úÖ `referrer`: direct, google.com, etc.
- ‚úÖ `created_at`: fecha reciente

**üß™ Prueba en vivo**:
1. Abre tu sitio: http://localhost:5174
2. Ve a /properties
3. Abre una propiedad (modal)
4. Espera 10 segundos
5. Cierra el modal
6. Ejecuta la query de nuevo
7. **Deber√≠as ver** una nueva fila con la vista que acabas de hacer

---

## ‚ù§Ô∏è PASO 5: Ver √öltimos Likes

```sql
-- Ver los √∫ltimos 10 likes registrados
SELECT 
  id,
  property_id,
  session_id,
  created_at as "fecha"
FROM property_likes
ORDER BY created_at DESC
LIMIT 10;
```

**üß™ Prueba en vivo**:
1. En tu sitio, click en el coraz√≥n verde üíö de una propiedad
2. Ejecuta la query
3. **Deber√≠as ver** un nuevo like
4. Click de nuevo en el coraz√≥n (quitar like)
5. Ejecuta la query
6. **El like deber√≠a desaparecer**

---

## üìû PASO 6: Ver √öltimos Contactos

```sql
-- Ver los √∫ltimos 10 contactos registrados
SELECT 
  id,
  property_id,
  contact_type as "tipo",
  name as "nombre",
  email,
  phone as "tel√©fono",
  message as "mensaje",
  created_at as "fecha"
FROM property_contacts
ORDER BY created_at DESC
LIMIT 10;
```

**¬øQu√© verificar?**
- ‚úÖ `contact_type`: debe ser 'whatsapp', 'email', 'phone' o 'schedule'
- ‚úÖ `name`, `email`, `phone`: datos del cliente
- ‚úÖ `message`: mensaje o informaci√≥n de la cita

**üß™ Prueba en vivo**:
1. Abre modal de una propiedad
2. Click "Contactar Asesor"
3. Llena el formulario
4. Click "Enviar por WhatsApp"
5. Ejecuta la query
6. **Deber√≠as ver** el contacto registrado

---

## üîí PASO 7: Verificar Pol√≠ticas RLS

```sql
-- Verificar que las pol√≠ticas de seguridad existen
SELECT 
  tablename as "tabla",
  policyname as "pol√≠tica",
  cmd as "comando"
FROM pg_policies
WHERE tablename IN ('property_likes', 'property_views', 'property_contacts')
ORDER BY tablename, cmd;
```

**Resultado esperado**:
- **property_likes**:
  - `Anyone can insert likes` (INSERT)
  - `Only admins can read likes` (SELECT)
  - `Users can read their own likes` (SELECT)
- **property_views**:
  - `Anyone can insert views` (INSERT)
  - `Only admins can read views` (SELECT)
- **property_contacts**:
  - `Anyone can insert contacts` (INSERT)
  - `Only admins can read contacts` (SELECT)

**‚ùå Si falta alguna pol√≠tica**:
```sql
-- Re-ejecutar la secci√≥n de pol√≠ticas del script CREATE_ANALYTICS_TABLES.sql
```

---

## üìä PASO 8: Ver Estad√≠sticas por Propiedad

```sql
-- Top 10 propiedades m√°s populares
SELECT 
  p.id,
  p.title as "t√≠tulo",
  p.code as "c√≥digo",
  COUNT(DISTINCT pl.id) as "likes",
  COUNT(DISTINCT pv.id) as "vistas",
  COUNT(DISTINCT pc.id) as "contactos",
  (COUNT(DISTINCT pl.id) * 3 + 
   COUNT(DISTINCT pv.id) * 1 + 
   COUNT(DISTINCT pc.id) * 5) as "score"
FROM properties p
LEFT JOIN property_likes pl ON p.id = pl.property_id
LEFT JOIN property_views pv ON p.id = pv.property_id
LEFT JOIN property_contacts pc ON p.id = pc.property_id
GROUP BY p.id, p.title, p.code
ORDER BY score DESC
LIMIT 10;
```

**¬øQu√© verificar?**
- ‚úÖ Propiedades con m√°s interacciones aparecen primero
- ‚úÖ Score calculado correctamente: (Likes √ó 3) + (Vistas √ó 1) + (Contactos √ó 5)
- ‚úÖ N√∫meros coherentes (likes ‚â§ vistas generalmente)

---

## üéØ PASO 9: Verificar Vista Consolidada

```sql
-- Verificar que la vista property_stats funciona
SELECT * FROM property_stats
ORDER BY popularity_score DESC
LIMIT 5;
```

**Resultado esperado**:
- Columnas: id, title, code, status, location, price, total_likes, total_views, total_contacts, unique_visitors, popularity_score
- Datos consolidados de todas las tablas

**‚ùå Si da error "relation does not exist"**:
```sql
-- Re-ejecutar la creaci√≥n de la vista desde CREATE_ANALYTICS_TABLES.sql
```

---

## ‚ö° PASO 10: Probar Funci√≥n get_top_properties

```sql
-- Obtener top 10 propiedades de los √∫ltimos 30 d√≠as
SELECT * FROM get_top_properties(10, 30);
```

**Par√°metros**:
- Primer n√∫mero: cantidad de resultados (10)
- Segundo n√∫mero: d√≠as hacia atr√°s (30)

**Variaciones**:
```sql
-- Top 5 de los √∫ltimos 7 d√≠as
SELECT * FROM get_top_properties(5, 7);

-- Top 20 de los √∫ltimos 90 d√≠as
SELECT * FROM get_top_properties(20, 90);
```

---

## üß™ PASO 11: Insertar Datos de Prueba (Opcional)

Si no tienes datos todav√≠a, puedes insertar datos de prueba:

```sql
-- 1. Obtener un property_id v√°lido
SELECT id, title FROM properties LIMIT 5;

-- 2. Copiar un ID y reemplazar abajo (ejemplo: 123)

-- Insertar vista de prueba
INSERT INTO property_views (property_id, session_id, view_duration, device_type, referrer)
VALUES (123, 'test_session_001', 45, 'desktop', 'direct');

-- Insertar like de prueba
INSERT INTO property_likes (property_id, session_id)
VALUES (123, 'test_session_001');

-- Insertar contacto de prueba
INSERT INTO property_contacts (
  property_id, 
  contact_type, 
  name, 
  email, 
  phone, 
  message,
  session_id
)
VALUES (
  123, 
  'whatsapp', 
  'Usuario Prueba', 
  'prueba@test.com', 
  '3001234567',
  'Mensaje de prueba',
  'test_session_001'
);

-- 3. Verificar que se insertaron
SELECT 'Vistas' as tipo, COUNT(*) as total FROM property_views WHERE session_id = 'test_session_001'
UNION ALL
SELECT 'Likes', COUNT(*) FROM property_likes WHERE session_id = 'test_session_001'
UNION ALL
SELECT 'Contactos', COUNT(*) FROM property_contacts WHERE session_id = 'test_session_001';
```

---

## üìä PASO 12: Diagn√≥stico R√°pido

Ejecuta este query para ver un resumen completo:

```sql
-- Resumen del sistema de analytics
SELECT 
  'üìä RESUMEN DEL SISTEMA' as "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";

SELECT 
  'Total Vistas' as m√©trica,
  COUNT(*) as cantidad,
  CASE WHEN COUNT(*) > 0 THEN '‚úÖ OK' ELSE '‚ö†Ô∏è Sin datos' END as estado
FROM property_views
UNION ALL
SELECT 
  'Total Likes' as m√©trica,
  COUNT(*) as cantidad,
  CASE WHEN COUNT(*) > 0 THEN '‚úÖ OK' ELSE '‚ö†Ô∏è Sin datos' END as estado
FROM property_likes
UNION ALL
SELECT 
  'Total Contactos' as m√©trica,
  COUNT(*) as cantidad,
  CASE WHEN COUNT(*) > 0 THEN '‚úÖ OK' ELSE '‚ö†Ô∏è Sin datos' END as estado
FROM property_contacts
UNION ALL
SELECT 
  'Sesiones √önicas' as m√©trica,
  COUNT(DISTINCT session_id) as cantidad,
  CASE WHEN COUNT(DISTINCT session_id) > 0 THEN '‚úÖ OK' ELSE '‚ö†Ô∏è Sin datos' END as estado
FROM (
  SELECT session_id FROM property_views
  UNION ALL
  SELECT session_id FROM property_likes
  UNION ALL
  SELECT session_id FROM property_contacts
) as sesiones;
```

---

## üîç PASO 13: Debugging Avanzado

### **Si no aparecen vistas:**

```sql
-- Verificar estructura de la tabla
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'property_views';
```

**Columnas esperadas**:
- id (bigint)
- property_id (bigint) ‚Üê **Importante: debe ser bigint**
- user_id (uuid)
- session_id (text)
- ip_address (text)
- view_duration (integer)
- referrer (text)
- device_type (text)
- created_at (timestamp with time zone)

### **Verificar tipo de dato de property_id**:

```sql
SELECT 
  column_name,
  data_type,
  CASE 
    WHEN data_type = 'bigint' THEN '‚úÖ Correcto'
    ELSE '‚ùå Incorrecto - deber√≠a ser bigint'
  END as verificaci√≥n
FROM information_schema.columns 
WHERE table_name IN ('property_views', 'property_likes', 'property_contacts')
  AND column_name = 'property_id';
```

### **Ver errores recientes (si hay)**:

```sql
-- Ver √∫ltimas inserciones intentadas (requiere logging habilitado)
-- Nota: Esto solo funciona si tienes logs habilitados en Supabase
```

---

## ‚úÖ Checklist Final

Marca cada item despu√©s de verificarlo:

- [ ] **Tablas creadas**: 5 tablas existen en Supabase
- [ ] **Pol√≠ticas RLS**: Al menos 5 pol√≠ticas creadas
- [ ] **property_id tipo BIGINT**: Verificado en las 3 tablas principales
- [ ] **Vista property_stats**: Existe y devuelve datos
- [ ] **Funci√≥n get_top_properties**: Existe y funciona
- [ ] **Datos de vistas**: Al menos 1 vista registrada
- [ ] **Datos de likes**: Al menos 1 like registrado
- [ ] **Datos de contactos**: Al menos 1 contacto registrado
- [ ] **Session IDs**: Gener√°ndose correctamente
- [ ] **Dashboard muestra datos**: Gr√°ficas y contadores actualizados

---

## üö® Problemas Comunes

### **Problema 1: "permission denied for table property_views"**

**Causa**: Pol√≠ticas RLS mal configuradas

**Soluci√≥n**:
```sql
-- Re-crear pol√≠ticas
CREATE POLICY "Anyone can insert views" ON property_views
  FOR INSERT WITH CHECK (true);
```

### **Problema 2: "No se insertan datos"**

**Verificar en consola del navegador**:
1. F12 ‚Üí Console
2. Buscar errores en rojo
3. Si dice "invalid input syntax for type bigint"
   - Problema resuelto con `parseInt()` en analytics.ts

### **Problema 3: "Vista no aparece en dashboard"**

**Verificar**:
1. ¬øHay datos en `property_views`? ‚Üí Si no, el tracking no funciona
2. ¬øEl dashboard est√° consultando correctamente? ‚Üí Ver consola
3. ¬øLas fechas est√°n dentro del rango seleccionado? ‚Üí Cambiar a "√öltimos 90 d√≠as"

---

## üìû Siguiente Paso

Despu√©s de validar:

1. **Si todo est√° OK** ‚úÖ:
   - Usa la aplicaci√≥n normalmente
   - Los datos se ir√°n acumulando
   - El dashboard se actualizar√° autom√°ticamente

2. **Si faltan datos** ‚ö†Ô∏è:
   - Inserta datos de prueba (Paso 11)
   - Prueba manualmente en el sitio
   - Verifica consola del navegador

3. **Si hay errores** ‚ùå:
   - Revisa las pol√≠ticas RLS
   - Verifica tipos de datos
   - Re-ejecuta CREATE_ANALYTICS_TABLES.sql

---

## üìù Archivo Complementario

Usa el archivo **`VALIDACION_SUPABASE.sql`** que contiene todas estas queries organizadas y listas para copiar/pegar.

---

**¬øListo para validar?** üöÄ

Abre Supabase y ejecuta las queries paso a paso. ¬°Av√≠same qu√© encuentras!
