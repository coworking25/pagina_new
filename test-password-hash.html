<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generar Hash de Contrase√±a</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
      color: #555;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    button {
      margin-top: 20px;
      padding: 12px 24px;
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #16a34a;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #f0fdf4;
      border-left: 4px solid #22c55e;
      border-radius: 4px;
      display: none;
    }
    .result h3 {
      margin-top: 0;
      color: #15803d;
    }
    .hash-output {
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
      color: #333;
    }
    .sql-query {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .copy-btn {
      background: #3b82f6;
      padding: 8px 16px;
      font-size: 14px;
      margin-top: 10px;
    }
    .copy-btn:hover {
      background: #2563eb;
    }
    .test-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #e5e7eb;
    }
    .success { color: #22c55e; font-weight: 600; }
    .error { color: #ef4444; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Generador de Hash bcrypt</h1>
    <p>Usa esta herramienta para generar el hash correcto de la contrase√±a <code>Test123456!</code></p>

    <label for="password">Contrase√±a:</label>
    <input 
      type="text" 
      id="password" 
      value="Test123456!" 
      placeholder="Ingresa la contrase√±a"
    >

    <label for="rounds">Rounds (costo):</label>
    <input 
      type="number" 
      id="rounds" 
      value="10" 
      min="4" 
      max="12"
    >
    <small style="color: #666;">Recomendado: 10 (mismo que usa el sistema)</small>

    <button onclick="generateHash()">Generar Hash</button>

    <div class="result" id="result">
      <h3>‚úÖ Hash Generado</h3>
      <div class="hash-output" id="hashOutput"></div>
      
      <button class="copy-btn" onclick="copyHash()">üìã Copiar Hash</button>

      <h4 style="margin-top: 20px;">SQL para actualizar en Supabase:</h4>
      <div class="sql-query" id="sqlQuery"></div>
      <button class="copy-btn" onclick="copySQL()">üìã Copiar SQL</button>
    </div>

    <div class="test-section">
      <h2>üß™ Probar Hash Existente</h2>
      <p>Verifica si un hash coincide con la contrase√±a:</p>

      <label for="testPassword">Contrase√±a a probar:</label>
      <input 
        type="text" 
        id="testPassword" 
        value="Test123456!" 
        placeholder="Ingresa la contrase√±a"
      >

      <label for="testHash">Hash existente (de la BD):</label>
      <textarea 
        id="testHash" 
        rows="3" 
        placeholder="Pega aqu√≠ el password_hash de la base de datos"
      ></textarea>

      <button onclick="testHash()">Verificar Coincidencia</button>

      <div id="testResult" style="margin-top: 15px; font-size: 16px;"></div>
    </div>
  </div>

  <script>
    let generatedHash = '';

    async function generateHash() {
      const password = document.getElementById('password').value;
      const rounds = parseInt(document.getElementById('rounds').value);

      if (!password) {
        alert('Por favor ingresa una contrase√±a');
        return;
      }

      try {
        console.log('üîÑ Generando hash...');
        console.log('Password:', password);
        console.log('Rounds:', rounds);

        // Generar hash
        const hash = await bcrypt.hash(password, rounds);
        generatedHash = hash;

        console.log('‚úÖ Hash generado:', hash);

        // Mostrar resultado
        document.getElementById('hashOutput').textContent = hash;
        
        const sql = `UPDATE client_credentials 
SET password_hash = '${hash}',
    failed_login_attempts = 0,
    locked_until = NULL,
    updated_at = NOW()
WHERE email = 'carlos.propietario@test.com'
RETURNING id, email, is_active;`;

        document.getElementById('sqlQuery').textContent = sql;
        document.getElementById('result').style.display = 'block';

        // Probar que funciona
        const match = await bcrypt.compare(password, hash);
        console.log('üß™ Auto-test:', match ? '‚úÖ V√°lido' : '‚ùå Error');

      } catch (error) {
        console.error('‚ùå Error al generar hash:', error);
        alert('Error: ' + error.message);
      }
    }

    async function testHash() {
      const password = document.getElementById('testPassword').value;
      const hash = document.getElementById('testHash').value.trim();
      const resultDiv = document.getElementById('testResult');

      if (!password || !hash) {
        alert('Por favor ingresa la contrase√±a y el hash');
        return;
      }

      try {
        console.log('üß™ Probando hash...');
        console.log('Password:', password);
        console.log('Hash:', hash);

        const match = await bcrypt.compare(password, hash);
        
        console.log('Resultado:', match);

        if (match) {
          resultDiv.innerHTML = '<span class="success">‚úÖ ¬°CORRECTO! La contrase√±a coincide con el hash</span>';
        } else {
          resultDiv.innerHTML = '<span class="error">‚ùå INCORRECTO: La contrase√±a NO coincide con el hash</span>';
        }

      } catch (error) {
        console.error('‚ùå Error al verificar:', error);
        resultDiv.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
      }
    }

    function copyHash() {
      navigator.clipboard.writeText(generatedHash);
      alert('‚úÖ Hash copiado al portapapeles');
    }

    function copySQL() {
      const sql = document.getElementById('sqlQuery').textContent;
      navigator.clipboard.writeText(sql);
      alert('‚úÖ SQL copiado al portapapeles');
    }

    // Esperar a que bcrypt se cargue antes de generar
    window.onload = function() {
      console.log('üöÄ P√°gina cargada. Esperando bcrypt...');
      setTimeout(() => {
        if (typeof dcodeIO !== 'undefined' && dcodeIO.bcrypt) {
          window.bcrypt = dcodeIO.bcrypt;
          console.log('‚úÖ bcrypt cargado correctamente');
          generateHash();
        } else if (typeof bcrypt !== 'undefined') {
          console.log('‚úÖ bcrypt cargado correctamente');
          generateHash();
        } else {
          console.error('‚ùå Error: bcrypt no se carg√≥');
          alert('Error al cargar la librer√≠a bcrypt. Recarga la p√°gina.');
        }
      }, 500);
    };
  </script>

  <!-- Cargar bcryptjs desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
</body>
</html>
